# üìù Sesi√≥n de Trabajo - 2026-01-23

## üéØ Objetivo de la Sesi√≥n

Probar el sistema multicanal en modo Tester y detectar/corregir errores que har√≠an que un cliente abandone la conversaci√≥n.

---

## ‚úÖ Trabajo Realizado

### 1. **Rebuild de Docker Backend**

Aplicamos los cambios del sistema multicanal:
```bash
docker-compose -f docker-compose.dev.yml stop backend
docker-compose -f docker-compose.dev.yml rm -f backend
docker-compose -f docker-compose.dev.yml up -d --build backend
```

**Resultado:**
- ‚úÖ Migraciones ejecutadas: 6 omitidas (ya estaban aplicadas)
- ‚úÖ Servidor iniciado correctamente en puerto 3001
- ‚úÖ Chatbot global: enabled
- ‚úÖ Visual flows: 4 flujos cargados
- ‚úÖ Chat Tester funcionando

---

### 2. **Monitoreo en Tiempo Real**

Iniciamos logs en tiempo real para analizar la ejecuci√≥n:
```bash
docker logs -f whatsapp-backend
```

**Conversaci√≥n de prueba:**
1. Usuario: "asdads" (mensaje aleatorio)
2. Usuario: "Hola" ‚Üí Activa flujo de bienvenida
3. Usuario: "Jerson" ‚Üí Responde pregunta de nombre
4. Usuario: "quiero comprar algo" ‚Üí Selecciona opci√≥n de compra
5. Usuario: "mmm que problema ?" ‚Üí Confusi√≥n por error
6. Usuario: "?" ‚Üí Intenta obtener respuesta

---

## üö® PROBLEMAS CR√çTICOS DETECTADOS

### **Error #1: Mensajes duplicados en BD (ER_DUP_ENTRY)** ‚úÖ SOLUCIONADO

**S√≠ntoma:**
```
Error: Duplicate entry 'simulated_1769222930678_crcjqv6ei' for key 'chat_messages.uniq_wa_msg_id'
```

**Causa:**
- `sendTextViaCloudAPI()` guarda el mensaje en BD (modificaci√≥n reciente)
- `chatbot.js` l√≠neas 209-212 intentaban guardar el mismo mensaje otra vez
- Resultado: Violaci√≥n de constraint UNIQUE en `wa_msg_id`

**Impacto:**
- Cliente NO ve el mensaje de respuesta
- Conversaci√≥n queda en silencio
- Cliente abandona por falta de respuesta

**Soluci√≥n aplicada:**

**Archivo:** `chatbot/chatbot.js` l√≠neas 205-227

**Antes:**
```javascript
// Enviar fallback
const waMsgId = await sendTextViaCloudAPI(phone, fallbackMessage);

// Guardar en BD ‚ùå DUPLICADO
const [result] = await pool.query(
  `INSERT INTO chat_messages (session_id, direction, text, wa_jid, wa_msg_id, status, is_ai_generated) VALUES (?,?,?,?,?,?,?)`,
  [sessionId, 'out', fallbackMessage, phone, waMsgId, 'sent', 0]
);
const messageId = result.insertId;
```

**Despu√©s:**
```javascript
// Enviar fallback (sendTextViaCloudAPI ya guarda en BD)
const waMsgId = await sendTextViaCloudAPI(phone, fallbackMessage, sessionId);

// Obtener el messageId del mensaje reci√©n insertado
const [[lastMsg]] = await pool.query(
  `SELECT id FROM chat_messages WHERE session_id=? AND wa_msg_id=? ORDER BY id DESC LIMIT 1`,
  [sessionId, waMsgId]
);
const messageId = lastMsg ? lastMsg.id : null;
```

**Estado:** ‚úÖ C√≥digo modificado, pendiente rebuild para probar

---

### **Error #2: Nodo AI Response sin OpenAI Key** ‚ö†Ô∏è PENDIENTE

**S√≠ntoma:**
```
Error: OpenAI client not initialized - check OPENAI_API_KEY
```

**Cu√°ndo ocurre:**
- Usuario selecciona "Quiero comprar algo"
- Flujo llega al nodo `ai_welcome` (tipo `ai_response`)
- No hay `OPENAI_API_KEY` configurado
- Falla y env√≠a: "Disculpa, hubo un problema. Un agente te atender√° pronto."

**Respuesta del cliente:**
```
Usuario: "mmm que problema ?"
Usuario: "?"
```

**Impacto:**
- Mensaje de error es **confuso** y **vago**
- Cliente no sabe qu√© sali√≥ mal
- Conversaci√≥n se corta abruptamente
- Genera desconfianza y posible abandono

**An√°lisis del nodo `ai_response`:**

**Ubicaci√≥n en c√≥digo:** `chatbot/visual-flow-engine.js` l√≠neas 924-987

**Qu√© hace:**
1. Toma `system_prompt` y `user_prompt` configurables
2. Llama a OpenAI API con modelo configurable (default: gpt-4o-mini)
3. Genera respuesta personalizada usando variables del flujo
4. Guarda respuesta en variable (opcional)
5. Env√≠a respuesta al usuario

**Prompts configurables:**
- `system_prompt`: "Eres un asistente √∫til." (default)
- `user_prompt`: Puede usar variables como `{{nombre}}`, `{{interes}}`, etc.

**Ejemplo de uso correcto (con OpenAI):**
```
System: "Eres un asesor de ventas amigable de nuestra tienda."
User: "El cliente {{nombre}} est√° interesado en {{interes}}. Genera un mensaje personalizado de bienvenida."

Respuesta AI: "¬°Genial Jerson! Veo que te interesa comprar. Tenemos excelentes ofertas en electr√≥nica y hogar. ¬øQu√© tipo de producto buscas espec√≠ficamente?"
```

**Problema actual:**
- Sin OpenAI Key, el nodo falla
- Mensaje de error gen√©rico no explica bien qu√© pas√≥
- El flujo se detiene abruptamente

**Opciones de soluci√≥n:**

**Opci√≥n A: Configurar OpenAI Key** (Recomendado para producci√≥n)
```env
OPENAI_API_KEY=sk-proj-...
```
Ventajas:
- Respuestas personalizadas y naturales
- Detecta intenci√≥n (compra vs reclamo vs consulta)
- Adapta el tono seg√∫n el contexto
- Usa variables del flujo para personalizar

**Opci√≥n B: Reemplazar con mensaje est√°tico**
- Cambiar el nodo `ai_welcome` por un nodo `message`
- Problema: No diferencia entre compra, reclamo, consulta
- Mensaje gen√©rico para todos los casos

**Opci√≥n C: Nodo condicional + m√∫ltiples mensajes**
- Usar nodo `condition` para detectar `{{interes}}`
- Si `interes == "comprar"` ‚Üí Mensaje de ventas
- Si `interes == "reclamo"` ‚Üí Mensaje de soporte
- Si `interes == "consulta"` ‚Üí Mensaje de informaci√≥n
- M√°s trabajo de configuraci√≥n pero sin necesitar AI

**Opci√≥n D: Mejorar el mensaje de error**
- Mantener el nodo AI pero cambiar el fallback
- En lugar de "Disculpa, hubo un problema"
- Usar: "Gracias por tu inter√©s. Un asesor especializado te atender√° en breve."
- M√°s claro y profesional

**Estado:** ‚ö†Ô∏è Pendiente decisi√≥n de qu√© opci√≥n implementar

---

### **Error #3: Texto libre en lugar de botones** ‚ö†Ô∏è PENDIENTE

**Escenario:**
- Bot pregunta: "¬øQu√© te trae por aqu√≠ hoy?"
- Muestra 3 botones:
  1. Quiero comprar algo
  2. Tengo una consulta
  3. Solo estoy mirando

**Comportamiento actual:**
- ‚úÖ Si usuario clickea bot√≥n ‚Üí Funciona perfecto
- ‚úÖ Si usuario escribe "quiero comprar algo" ‚Üí Matchea por label (funciona)
- ‚ùå Si usuario escribe algo que NO matchea ‚Üí Cae a fallback gen√©rico

**Problema:**
- El flujo queda esperando respuesta
- Usuario escribe texto libre que no matchea
- Bot responde fallback gen√©rico
- Flujo no avanza, queda en limbo
- Usuario confundido

**Soluci√≥n propuesta:**

Implementar l√≥gica de "re-ask" cuando no hay match:

```javascript
// En visual-flow-engine.js, al procesar respuesta a question node
if (node.type === 'question' && node.buttons && !matchedOption) {
  // No matche√≥ ning√∫n bot√≥n
  await this.sendMessage(phone, 'Por favor, selecciona una de las opciones clickeando los botones:');

  // Re-enviar los mismos botones
  await this.sendInteractiveButtons(
    phone,
    node.text,
    node.buttons,
    node.header,
    node.footer
  );

  return { type: 'waiting_for_valid_option' };
}
```

**Estado:** ‚ö†Ô∏è Pendiente implementaci√≥n

---

## üìä An√°lisis del Flujo

### **Flujo: "Bienvenida Nuevos Usuarios"**

**Trigger:**
- Keyword: "hola", "ola", "buenas", etc.

**Nodos ejecutados:**

1. **trigger** (trigger) ‚Üí Inicia flujo
2. **delay1** (delay) ‚Üí Espera 2 segundos, muestra "typing..."
3. **greeting** (message) ‚Üí "¬°Hola! Bienvenido/a a nuestra tienda..."
4. **ask_name** (question) ‚Üí "¬øC√≥mo te llamas?"
5. ‚Üí Usuario responde "Jerson"
6. ‚Üí Guarda variable `{{nombre}}` = "Jerson"
7. **ask_interest** (question) ‚Üí "Mucho gusto Jerson. ¬øQu√© te trae por aqu√≠ hoy?"
   - Bot√≥n 1: "Quiero comprar algo" ‚Üí value: "comprar"
   - Bot√≥n 2: "Tengo una consulta" ‚Üí value: "consulta"
   - Bot√≥n 3: "Solo estoy mirando" ‚Üí value: "mirando"
8. ‚Üí Usuario responde "quiero comprar algo" (texto libre, matchea por label)
9. ‚Üí Guarda variable `{{interes}}` = "comprar"
10. **save_contact** (action: save_lead) ‚Üí Guarda contacto en BD
11. **ai_welcome** (ai_response) ‚Üí ‚ùå FALLA (no hay OpenAI key)
12. ‚Üí Env√≠a: "Disculpa, hubo un problema..."
13. ‚Üí Cliente confundido, pregunta "mmm que problema ?"

---

## üîß Variables del Flujo

Durante la ejecuci√≥n se guardaron estas variables:

```javascript
{
  nombre: "Jerson",
  interes: "comprar",
  initial_message: "Hola"  // Mensaje original del trigger
}
```

Estas variables est√°n disponibles para usar en:
- Mensajes con `{{nombre}}`
- Prompts de AI con `{{interes}}`
- Condiciones con `{{variable}} == "valor"`
- Webhooks en el body/headers

---

## üéØ PREGUNTA PENDIENTE

**Usuario pregunt√≥:**
> "pero y si no es venta y es reclamo"

**Contexto:**
El nodo `ai_welcome` actualmente usa AI para generar respuestas personalizadas seg√∫n el contexto.

**Con OpenAI configurado**, el nodo podr√≠a:
- Detectar si `{{interes}} == "comprar"` ‚Üí Respuesta de ventas
- Detectar si `{{interes}} == "reclamo"` ‚Üí Respuesta de soporte emp√°tica
- Detectar si `{{interes}} == "consulta"` ‚Üí Respuesta informativa

**Sin OpenAI**, necesitamos otra estrategia:
- Nodo condicional que chequee `{{interes}}`
- Diferentes nodos de mensaje para cada caso
- O un mensaje gen√©rico que cubra todos los casos

**Decisi√≥n pendiente para ma√±ana:**
- ¬øConfiguramos OpenAI key para usar AI responses?
- ¬øO implementamos l√≥gica condicional manual sin AI?

---

## üìÅ Archivos Modificados

### **chatbot/chatbot.js**

**L√≠neas 205-227:**
- ‚úÖ Eliminado INSERT duplicado en fallback
- ‚úÖ Ahora obtiene `messageId` con SELECT en lugar de INSERT
- ‚úÖ Pasa `sessionId` a `sendTextViaCloudAPI()`

---

## ‚è≠Ô∏è PR√ìXIMOS PASOS (Para ma√±ana)

### **1. Rebuild y prueba del Error #1**
```bash
docker-compose -f docker-compose.dev.yml up -d --build backend
```
- Probar que ya no haya `ER_DUP_ENTRY`
- Verificar que mensajes de fallback se guarden correctamente

### **2. Decidir soluci√≥n para Error #2 (AI Response)**

**Si configuramos OpenAI:**
```env
# Agregar al .env
OPENAI_API_KEY=sk-proj-xxxxxxxxxxxxx
```

**Si NO usamos OpenAI:**
- Opci√≥n A: Cambiar `ai_welcome` a nodo condicional
- Opci√≥n B: Cambiar a mensaje est√°tico gen√©rico
- Opci√≥n C: Mejorar solo el mensaje de error

### **3. Implementar Error #3 (Re-ask en botones)**

**Modificar:** `chatbot/visual-flow-engine.js`

**L√≥gica:**
```javascript
// Cuando node.type === 'question' y tiene botones
if (!matchedOption && node.buttons) {
  // Re-ask: volver a preguntar con los mismos botones
  // Guardar contador de intentos
  // Despu√©s de 2-3 intentos, derivar a humano
}
```

### **4. Casos de prueba completos**

**Escenario 1: Flujo de compra completo**
```
Usuario: "hola"
Bot: "¬°Hola! Bienvenido..."
Bot: "¬øC√≥mo te llamas?"
Usuario: "Mar√≠a"
Bot: "Mucho gusto Mar√≠a. ¬øQu√© te trae por aqu√≠ hoy?"
Usuario: [Click en "Quiero comprar algo"]
Bot: [Respuesta personalizada de ventas]
```

**Escenario 2: Flujo de reclamo completo**
```
Usuario: "hola"
Bot: "¬°Hola! Bienvenido..."
Bot: "¬øC√≥mo te llamas?"
Usuario: "Carlos"
Bot: "Mucho gusto Carlos. ¬øQu√© te trae por aqu√≠ hoy?"
Usuario: [Click en "Tengo un reclamo"]
Bot: [Respuesta emp√°tica de soporte]
```

**Escenario 3: Usuario escribe texto libre**
```
Usuario: "hola"
Bot: "¬øC√≥mo te llamas?"
Usuario: "Pedro"
Bot: "¬øQu√© te trae por aqu√≠ hoy?" [botones]
Usuario: "necesito ayuda con un pedido"  ‚Üê NO matchea
Bot: "Por favor, selecciona una de las opciones:" [re-env√≠a botones]
```

**Escenario 4: Mensaje sin flujo**
```
Usuario: "cu√°nto cuesta el producto X"
Bot: [Fallback] "Gracias por tu mensaje..." ‚Üê Debe guardarse SIN duplicados
```

### **5. Documentar decisi√≥n final**

Actualizar `README-MULTICANAL.md` con:
- Estrategia elegida para nodos AI (con/sin OpenAI)
- L√≥gica de re-ask implementada
- Ejemplos de flujos completos

---

## üìù Notas T√©cnicas

### **Estructura de nodo `ai_response`**

```javascript
{
  id: "ai_welcome",
  type: "ai_response",
  system_prompt: "Eres un asesor de {{interes}} de nuestra empresa.",
  user_prompt: "El cliente {{nombre}} est√° interesado en {{interes}}. Genera un mensaje de bienvenida apropiado.",
  model: "gpt-4o-mini",  // o gpt-4, gpt-3.5-turbo
  temperature: 0.7,
  max_tokens: 200,
  variable: "ai_greeting"  // Guarda respuesta en esta variable
}
```

### **Estructura de nodo `condition`**

```javascript
{
  id: "check_interest",
  type: "condition",
  conditions: [
    {
      variable: "interes",
      operator: "equals",
      value: "comprar",
      next: "sales_message"
    },
    {
      variable: "interes",
      operator: "equals",
      value: "reclamo",
      next: "support_message"
    },
    {
      variable: "interes",
      operator: "equals",
      value: "consulta",
      next: "info_message"
    }
  ],
  default_next: "generic_message"
}
```

---

## üêõ Bugs Conocidos (Pendientes)

1. ‚ùå **ER_DUP_ENTRY en fallback** ‚Üí ‚úÖ Solucionado en c√≥digo, pendiente rebuild
2. ‚ùå **AI response falla sin OpenAI key** ‚Üí ‚ö†Ô∏è Pendiente decisi√≥n
3. ‚ùå **No hay re-ask cuando usuario escribe texto libre en lugar de botones** ‚Üí ‚ö†Ô∏è Pendiente implementaci√≥n
4. ‚ö†Ô∏è **Warning de collation en MySQL** ‚Üí Cosm√©tico, no afecta funcionamiento

---

## üìå Comandos √ötiles

```bash
# Rebuild backend
docker-compose -f docker-compose.dev.yml up -d --build backend

# Ver logs en tiempo real
docker logs -f whatsapp-backend

# Acceder a MySQL
docker exec -it whatsapp-db mysql -uroot -p whatsapp_chat

# Ver sesiones activas
SELECT id, phone, channel, status, created_at FROM chat_sessions WHERE status='OPEN';

# Ver mensajes de una sesi√≥n
SELECT id, direction, text, channel, created_at FROM chat_messages WHERE session_id=5 ORDER BY id DESC LIMIT 20;

# Ver flujos activos
SELECT id, name, slug, is_default FROM visual_flows WHERE active=1;
```

---

## ‚úÖ Checklist para Ma√±ana

- [ ] Rebuild de Docker con fix del Error #1
- [ ] Probar que no haya m√°s `ER_DUP_ENTRY`
- [ ] Decidir: ¬øOpenAI key o l√≥gica manual?
- [ ] Implementar soluci√≥n elegida para Error #2
- [ ] Implementar re-ask para Error #3
- [ ] Pruebas completas de todos los escenarios
- [ ] Actualizar documentaci√≥n
- [ ] Commit de cambios

---

**Fecha:** 2026-01-23
**Pr√≥xima sesi√≥n:** 2026-01-24
**Estado:** 1 de 3 errores cr√≠ticos solucionado, 2 pendientes de decisi√≥n/implementaci√≥n
